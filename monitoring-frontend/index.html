<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NKP-CICD Cluster Monitoring</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f0f14;
      --surface: #18181f;
      --border: #2a2a35;
      --text: #e4e4eb;
      --muted: #8b8b9a;
      --accent: #7c6ef6;
      --success: #22c55e;
      --warning: #eab308;
      --error: #ef4444;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 1.5rem;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #a78bfa, #7c6ef6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle { color: var(--muted); font-size: 0.95rem; margin-bottom: 1.5rem; }
    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .health-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.8rem;
      border-radius: 9999px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .health-badge.healthy { background: rgba(34, 197, 94, 0.2); color: var(--success); }
    .health-badge.degraded { background: rgba(239, 68, 68, 0.2); color: var(--error); }
    .health-badge.loading { background: var(--surface); color: var(--muted); }
    .health-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .health-badge.healthy .dot { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    button.refresh {
      font-family: inherit;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button.refresh:hover { background: var(--border); }
    .api-docs-link {
      color: var(--muted);
      font-size: 0.85rem;
      text-decoration: none;
    }
    .api-docs-link:hover { color: var(--accent); }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .namespace-label { color: var(--muted); font-size: 0.9rem; white-space: nowrap; }
    #namespace-select {
      font-family: inherit;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.4rem 0.75rem;
      border-radius: 8px;
      font-size: 0.9rem;
      min-width: 180px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      overflow: hidden;
    }
    .card h2 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .card .value { font-size: 1.75rem; font-weight: 700; color: var(--accent); font-family: 'JetBrains Mono', monospace; }
    .card .meta { font-size: 0.8rem; color: var(--muted); margin-top: 0.25rem; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td { text-align: left; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; }
    tr:last-child td { border-bottom: none; }
    .status-dot {
      display: inline-block;
      width: 8px; height: 8px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    .status-dot.ready, .status-dot.Healthy { background: var(--success); }
    .status-dot.notready, .status-dot.NotReady { background: var(--error); }
    .status-dot.pending { background: var(--warning); }
    .status-dot.unknown { background: var(--muted); }
    .error-msg { color: var(--error); font-size: 0.9rem; padding: 1rem; background: rgba(239,68,68,0.1); border-radius: 8px; margin-top: 0.5rem; }
    .timestamp { font-size: 0.75rem; color: var(--muted); margin-top: 1rem; }
    .loading { color: var(--muted); }
    .muted { color: var(--muted); font-size: 0.9rem; }

    /* Sticky header */
    .header-sticky {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg);
      padding: 1rem 0;
      margin: -1rem 0 1rem 0;
      border-bottom: 1px solid var(--border);
    }
    .header-sticky .header-row { margin-bottom: 0.75rem; }
    .last-updated-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .last-updated-row .refresh-now { margin-left: auto; }

    /* Quick-jump nav */
    .nav-jump {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .nav-jump a {
      color: var(--muted);
      text-decoration: none;
      font-size: 0.8rem;
      padding: 0.35rem 0.65rem;
      border-radius: 6px;
      background: var(--surface);
      border: 1px solid var(--border);
    }
    .nav-jump a:hover { color: var(--accent); background: var(--border); }

    /* Section grouping */
    .section-head {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent);
      margin: 1.5rem 0 0.5rem 0;
      padding-bottom: 0.25rem;
      letter-spacing: 0.03em;
    }
    .section-head:first-of-type { margin-top: 0.5rem; }

    /* Collapsible table sections */
    details.section-card {
      margin-bottom: 0.5rem;
    }
    details.section-card .card { margin-bottom: 0; border-radius: 0 0 12px 12px; }
    details.section-card[open] .card { border-radius: 12px; }
    details.section-card > summary {
      list-style: none;
      cursor: pointer;
      padding: 0.85rem 1.25rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--muted);
      user-select: none;
    }
    details.section-card > summary::-webkit-details-marker { display: none; }
    details.section-card > summary::after {
      content: '▼';
      float: right;
      font-size: 0.7rem;
      color: var(--muted);
      transition: transform 0.2s;
    }
    details.section-card[open] > summary::after { transform: rotate(-180deg); }
    details.section-card > summary:hover { background: var(--border); color: var(--text); }
    details.section-card[open] > summary { border-radius: 12px 12px 0 0; border-bottom-color: transparent; }
    details.section-card .card { border-top: none; border-radius: 0 0 12px 12px; }

    /* Scrollable table wrapper */
    .table-wrap { overflow-x: auto; max-height: 400px; overflow-y: auto; }
    .table-wrap table { min-width: 600px; }
    .table-wrap thead th { position: sticky; top: 0; background: var(--surface); z-index: 1; }

    /* Compact summary cards */
    .grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; }
    .card.summary-card { padding: 0.85rem 1rem; }
    .card.summary-card h2 { font-size: 0.8rem; margin-bottom: 0.4rem; }
    .card.summary-card .value { font-size: 1.4rem; }
    .card.summary-card .meta { font-size: 0.72rem; }

    /* Button focus */
    button.refresh:focus-visible, .nav-jump a:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    #namespace-select:focus, #interval-select:focus { outline: 2px solid var(--accent); outline-offset: 1px; }

    /* Refreshing indicator */
    .refreshing .refresh-now { color: var(--accent); }
  </style>
</head>
<body>
  <div class="container">
    <header class="header-sticky">
      <div class="header-row">
        <div>
          <h1>NKP-CICD Cluster Monitoring</h1>
          <p class="subtitle">Cluster resources and Flux workloads</p>
        </div>
        <div class="header-controls">
          <label for="namespace-select" class="namespace-label">Namespace</label>
          <select id="namespace-select" onchange="loadAll()">
            <option value="">All namespaces</option>
          </select>
          <div id="health-badge" class="health-badge loading"><span class="dot"></span> <span>Checking…</span></div>
          <label for="interval-select" class="namespace-label">Refresh</label>
          <select id="interval-select" onchange="applyInterval()">
            <option value="15">15s</option>
            <option value="30" selected>30s</option>
            <option value="60">60s</option>
            <option value="0">Off</option>
          </select>
          <a href="/api/docs" target="_blank" rel="noopener" class="api-docs-link">API docs</a>
          <button class="refresh" type="button" onclick="loadAll()">Refresh</button>
          <button class="refresh" type="button" onclick="copySummary()" title="Copy summary JSON">Copy summary</button>
        </div>
      </div>
      <div class="last-updated-row">
        <span id="page-timestamp">—</span>
        <span id="page-relative">—</span>
        <span class="refresh-now" id="refresh-status" aria-live="polite"></span>
      </div>
      <nav class="nav-jump" aria-label="Jump to section">
        <a href="#section-workloads">Workloads</a>
        <a href="#section-networking">Networking</a>
        <a href="#section-storage">Storage</a>
        <a href="#section-config">Config</a>
        <a href="#section-batch">Batch</a>
        <a href="#section-flux">Flux</a>
      </nav>
    </header>

    <div class="grid">
      <div class="card summary-card">
        <h2>Nodes</h2>
        <div id="nodes-value" class="value loading">—</div>
        <div class="meta" id="nodes-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>Pods</h2>
        <div id="pods-value" class="value loading">—</div>
        <div class="meta" id="pods-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>Deployments</h2>
        <div id="deployments-value" class="value loading">—</div>
        <div class="meta" id="deployments-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>Flux Kustomizations</h2>
        <div id="flux-k-value" class="value loading">—</div>
        <div class="meta" id="flux-k-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>Flux HelmReleases</h2>
        <div id="flux-helm-value" class="value loading">—</div>
        <div class="meta" id="flux-helm-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>Services</h2>
        <div id="services-value" class="value loading">—</div>
        <div class="meta" id="services-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>Ingresses</h2>
        <div id="ingresses-value" class="value loading">—</div>
        <div class="meta" id="ingresses-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>PV</h2>
        <div id="pv-value" class="value loading">—</div>
        <div class="meta" id="pv-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>PVC</h2>
        <div id="pvc-value" class="value loading">—</div>
        <div class="meta" id="pvc-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>StorageClasses</h2>
        <div id="sc-value" class="value loading">—</div>
        <div class="meta" id="sc-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>StatefulSets</h2>
        <div id="statefulsets-value" class="value loading">—</div>
        <div class="meta" id="statefulsets-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>DaemonSets</h2>
        <div id="daemonsets-value" class="value loading">—</div>
        <div class="meta" id="daemonsets-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>ConfigMaps</h2>
        <div id="configmaps-value" class="value loading">—</div>
        <div class="meta" id="configmaps-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>Secrets</h2>
        <div id="secrets-value" class="value loading">—</div>
        <div class="meta" id="secrets-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>Jobs</h2>
        <div id="jobs-value" class="value loading">—</div>
        <div class="meta" id="jobs-meta">—</div>
      </div>
      <div class="card summary-card">
        <h2>CronJobs</h2>
        <div id="cronjobs-value" class="value loading">—</div>
        <div class="meta" id="cronjobs-meta">—</div>
      </div>
    </div>

    <h2 class="section-head" id="section-workloads">Workloads</h2>
    <details class="section-card" open>
      <summary>Nodes</summary>
      <div class="card"><div id="nodes-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>
    <details class="section-card" open>
      <summary>Pods</summary>
      <div class="card"><div id="pods-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>
    <details class="section-card">
      <summary>Deployments</summary>
      <div class="card"><div id="deployments-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>
    <details class="section-card">
      <summary>StatefulSets</summary>
      <div class="card"><div id="statefulsets-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>
    <details class="section-card">
      <summary>DaemonSets</summary>
      <div class="card"><div id="daemonsets-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>

    <h2 class="section-head" id="section-networking">Networking</h2>
    <details class="section-card">
      <summary>Services</summary>
      <div class="card"><div id="services-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>
    <details class="section-card">
      <summary>Ingresses</summary>
      <div class="card"><div id="ingresses-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>

    <h2 class="section-head" id="section-storage">Storage</h2>
    <details class="section-card">
      <summary>PersistentVolumes (PV)</summary>
      <div class="card"><div id="pv-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>
    <details class="section-card">
      <summary>PersistentVolumeClaims (PVC)</summary>
      <div class="card"><div id="pvc-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>
    <details class="section-card">
      <summary>StorageClasses (SC)</summary>
      <div class="card"><div id="sc-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>

    <h2 class="section-head" id="section-config">Config &amp; Secrets</h2>
    <details class="section-card">
      <summary>ConfigMaps</summary>
      <div class="card"><div id="configmaps-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>
    <details class="section-card">
      <summary>Secrets</summary>
      <div class="card"><div id="secrets-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>

    <h2 class="section-head" id="section-batch">Batch</h2>
    <details class="section-card">
      <summary>Jobs</summary>
      <div class="card"><div id="jobs-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>
    <details class="section-card">
      <summary>CronJobs</summary>
      <div class="card"><div id="cronjobs-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>

    <h2 class="section-head" id="section-flux">Flux</h2>
    <details class="section-card" open>
      <summary>Kustomizations</summary>
      <div class="card"><div id="flux-k-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>
    <details class="section-card">
      <summary>HelmReleases</summary>
      <div class="card"><div id="flux-helm-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>
    <details class="section-card">
      <summary>GitRepositories</summary>
      <div class="card"><div id="flux-git-table-wrap" class="table-wrap"><p class="loading">Loading…</p></div></div>
    </details>
  </div>

  <script>
    // Same origin when behind Ingress (path /api -> backend). If using separate LoadBalancers, set e.g. window.API_BASE = 'http://backend-ip:8080' before load.
    const API = window.API_BASE || '';
    let lastUpdatedAt = null;
    let refreshIntervalId = null;

    function setHealth(healthy) {
      const el = document.getElementById('health-badge');
      el.className = 'health-badge ' + (healthy === true ? 'healthy' : healthy === false ? 'degraded' : 'loading');
      el.innerHTML = '<span class="dot"></span> <span>' + (healthy === true ? 'Healthy' : healthy === false ? 'Degraded' : 'Checking…') + '</span>';
    }

    function renderNodes(data) {
      const wrap = document.getElementById('nodes-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const nodes = data.nodes || [];
      document.getElementById('nodes-value').textContent = nodes.length;
      document.getElementById('nodes-value').className = 'value';
      const ready = nodes.filter(n => n.status === 'Ready').length;
      document.getElementById('nodes-meta').textContent = ready + ' ready';
      if (nodes.length === 0) {
        wrap.innerHTML = '<p class="muted">No nodes</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Status</th><th>Roles</th></tr></thead><tbody>' +
        nodes.map(n => '<tr><td><span class="status-dot ' + (n.status === 'Ready' ? 'ready' : 'notready') + '"></span>' + escapeHtml(n.name) + '</td><td>' + escapeHtml(n.status) + '</td><td>' + escapeHtml(String(n.roles)) + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function renderPods(data) {
      const wrap = document.getElementById('pods-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const pods = data.pods || [];
      document.getElementById('pods-value').textContent = pods.length;
      document.getElementById('pods-value').className = 'value';
      const nsSel = document.getElementById('namespace-select').value;
      document.getElementById('pods-meta').textContent = nsSel ? 'Namespace: ' + nsSel : 'All namespaces';
      const sample = pods.slice(0, 50);
      if (sample.length === 0) {
        wrap.innerHTML = '<p class="muted">No pods</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th><th>Phase</th><th>Ready</th><th>Node</th></tr></thead><tbody>' +
        sample.map(p => '<tr><td>' + escapeHtml(p.name) + '</td><td>' + escapeHtml(p.namespace) + '</td><td>' + escapeHtml(p.phase) + '</td><td>' + escapeHtml(p.ready) + '</td><td>' + escapeHtml(p.node || '—') + '</td></tr>').join('') +
        '</tbody></table>' + (pods.length > 50 ? '<p class="meta">Showing first 50 of ' + pods.length + '</p>' : '');
    }

    function renderDeployments(data) {
      const wrap = document.getElementById('deployments-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const deployments = data.deployments || [];
      document.getElementById('deployments-value').textContent = deployments.length;
      document.getElementById('deployments-value').className = 'value';
      const allReady = deployments.filter(d => d.ready === d.desired).length;
      const nsSel2 = document.getElementById('namespace-select').value;
      document.getElementById('deployments-meta').textContent = (nsSel2 ? 'Namespace: ' + nsSel2 + ' · ' : '') + allReady + '/' + deployments.length + ' ready';
      if (deployments.length === 0) {
        wrap.innerHTML = '<p class="muted">No deployments</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th><th>Ready</th><th>Desired</th></tr></thead><tbody>' +
        deployments.map(d => '<tr><td>' + escapeHtml(d.name) + '</td><td>' + escapeHtml(d.namespace) + '</td><td>' + d.ready + '</td><td>' + d.desired + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function renderFluxK(data) {
      const wrap = document.getElementById('flux-k-table-wrap');
      const kustomizations = data.kustomizations || [];
      document.getElementById('flux-k-value').textContent = data.error ? '—' : kustomizations.length;
      document.getElementById('flux-k-value').className = 'value';
      document.getElementById('flux-k-meta').textContent = data.error || (kustomizations.length + ' Kustomizations');
      if (data.error) {
        wrap.innerHTML = '<p class="muted">' + escapeHtml(data.error) + ' (Flux may not be installed)</p>';
        return;
      }
      if (kustomizations.length === 0) {
        wrap.innerHTML = '<p class="muted">No Kustomizations</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th><th>Ready</th><th>Revision</th><th>Message</th></tr></thead><tbody>' +
        kustomizations.map(k => '<tr><td>' + escapeHtml(k.name) + '</td><td>' + escapeHtml(k.namespace) + '</td><td><span class="status-dot ' + (k.ready ? 'ready' : 'notready') + '"></span>' + (k.ready ? 'Yes' : 'No') + '</td><td>' + escapeHtml(k.lastAppliedRevision || '—') + '</td><td>' + escapeHtml(k.message || '') + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function renderServices(data) {
      const wrap = document.getElementById('services-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const services = data.services || [];
      document.getElementById('services-value').textContent = services.length;
      document.getElementById('services-value').className = 'value';
      const nsSel = document.getElementById('namespace-select').value;
      document.getElementById('services-meta').textContent = nsSel ? 'Namespace: ' + nsSel : 'All namespaces';
      if (services.length === 0) {
        wrap.innerHTML = '<p class="muted">No services</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th><th>Type</th><th>Cluster IP</th><th>External IP</th><th>Ports</th></tr></thead><tbody>' +
        services.map(s => '<tr><td>' + escapeHtml(s.name) + '</td><td>' + escapeHtml(s.namespace) + '</td><td>' + escapeHtml(s.type || '—') + '</td><td>' + escapeHtml(s.clusterIP || '—') + '</td><td>' + escapeHtml(s.externalIP || '—') + '</td><td>' + escapeHtml(s.ports || '—') + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function renderIngresses(data) {
      const wrap = document.getElementById('ingresses-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const ingresses = data.ingresses || [];
      document.getElementById('ingresses-value').textContent = ingresses.length;
      document.getElementById('ingresses-value').className = 'value';
      const nsSel = document.getElementById('namespace-select').value;
      document.getElementById('ingresses-meta').textContent = nsSel ? 'Namespace: ' + nsSel : 'All namespaces';
      if (ingresses.length === 0) {
        wrap.innerHTML = '<p class="muted">No ingresses</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th><th>Hosts</th><th>Ingress Class</th></tr></thead><tbody>' +
        ingresses.map(i => '<tr><td>' + escapeHtml(i.name) + '</td><td>' + escapeHtml(i.namespace) + '</td><td>' + escapeHtml(i.hosts || '—') + '</td><td>' + escapeHtml(i.ingressClassName || '—') + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function renderFluxHelm(data) {
      const wrap = document.getElementById('flux-helm-table-wrap');
      const releases = data.helmreleases || [];
      document.getElementById('flux-helm-value').textContent = data.error ? '—' : releases.length;
      document.getElementById('flux-helm-value').className = 'value';
      document.getElementById('flux-helm-meta').textContent = data.error || (releases.length + ' HelmReleases');
      if (data.error) {
        wrap.innerHTML = '<p class="muted">' + escapeHtml(data.error) + '</p>';
        return;
      }
      if (releases.length === 0) {
        wrap.innerHTML = '<p class="muted">No HelmReleases</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th><th>Ready</th><th>Message</th></tr></thead><tbody>' +
        releases.map(r => '<tr><td>' + escapeHtml(r.name) + '</td><td>' + escapeHtml(r.namespace) + '</td><td><span class="status-dot ' + (r.ready ? 'ready' : 'notready') + '"></span>' + (r.ready ? 'Yes' : 'No') + '</td><td>' + escapeHtml(r.message || '') + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function renderFluxGit(data) {
      const wrap = document.getElementById('flux-git-table-wrap');
      const repos = data.gitrepositories || [];
      if (data.error) {
        wrap.innerHTML = '<p class="muted">' + escapeHtml(data.error) + '</p>';
        return;
      }
      if (repos.length === 0) {
        wrap.innerHTML = '<p class="muted">No GitRepositories</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th><th>Ready</th><th>URL</th><th>Revision</th></tr></thead><tbody>' +
        repos.map(r => '<tr><td>' + escapeHtml(r.name) + '</td><td>' + escapeHtml(r.namespace) + '</td><td><span class="status-dot ' + (r.ready ? 'ready' : 'notready') + '"></span>' + (r.ready ? 'Yes' : 'No') + '</td><td>' + escapeHtml(r.url || '—') + '</td><td>' + escapeHtml(r.revision || '—') + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function renderPv(data) {
      const wrap = document.getElementById('pv-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const pvs = data.persistentvolumes || [];
      document.getElementById('pv-value').textContent = pvs.length;
      document.getElementById('pv-value').className = 'value';
      const bound = pvs.filter(p => p.status === 'Bound').length;
      document.getElementById('pv-meta').textContent = bound + ' bound';
      if (pvs.length === 0) {
        wrap.innerHTML = '<p class="muted">No PersistentVolumes</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Status</th><th>StorageClass</th><th>Capacity</th><th>Access Modes</th></tr></thead><tbody>' +
        pvs.map(p => '<tr><td>' + escapeHtml(p.name) + '</td><td><span class="status-dot ' + (p.status === 'Bound' ? 'ready' : p.status === 'Available' ? 'pending' : 'unknown') + '"></span>' + escapeHtml(p.status) + '</td><td>' + escapeHtml(p.storageClass || '—') + '</td><td>' + escapeHtml(p.capacity || '—') + '</td><td>' + escapeHtml(p.accessModes || '—') + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function renderPvc(data) {
      const wrap = document.getElementById('pvc-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const pvcs = data.persistentvolumeclaims || [];
      document.getElementById('pvc-value').textContent = pvcs.length;
      document.getElementById('pvc-value').className = 'value';
      const nsSel = document.getElementById('namespace-select').value;
      document.getElementById('pvc-meta').textContent = nsSel ? 'Namespace: ' + nsSel : 'All namespaces';
      if (pvcs.length === 0) {
        wrap.innerHTML = '<p class="muted">No PersistentVolumeClaims</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th><th>Status</th><th>StorageClass</th><th>Capacity</th><th>Volume</th></tr></thead><tbody>' +
        pvcs.map(p => '<tr><td>' + escapeHtml(p.name) + '</td><td>' + escapeHtml(p.namespace) + '</td><td><span class="status-dot ' + (p.status === 'Bound' ? 'ready' : p.status === 'Pending' ? 'pending' : 'unknown') + '"></span>' + escapeHtml(p.status) + '</td><td>' + escapeHtml(p.storageClass || '—') + '</td><td>' + escapeHtml(p.capacity || '—') + '</td><td>' + escapeHtml(p.volume || '—') + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function renderStorageClasses(data) {
      const wrap = document.getElementById('sc-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const scs = data.storageclasses || [];
      document.getElementById('sc-value').textContent = scs.length;
      document.getElementById('sc-value').className = 'value';
      const def = scs.filter(s => s.isDefault).length;
      document.getElementById('sc-meta').textContent = def ? def + ' default' : 'StorageClasses';
      if (scs.length === 0) {
        wrap.innerHTML = '<p class="muted">No StorageClasses</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Provisioner</th><th>Reclaim Policy</th><th>Default</th></tr></thead><tbody>' +
        scs.map(s => '<tr><td>' + escapeHtml(s.name) + '</td><td>' + escapeHtml(s.provisioner || '—') + '</td><td>' + escapeHtml(s.reclaimPolicy || '—') + '</td><td>' + (s.isDefault ? 'Yes' : '—') + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function renderStatefulSets(data) {
      const wrap = document.getElementById('statefulsets-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const items = data.statefulsets || [];
      document.getElementById('statefulsets-value').textContent = items.length;
      document.getElementById('statefulsets-value').className = 'value';
      const allReady = items.filter(d => d.ready === d.desired).length;
      const nsSel = document.getElementById('namespace-select').value;
      document.getElementById('statefulsets-meta').textContent = (nsSel ? 'Namespace: ' + nsSel + ' · ' : '') + allReady + '/' + items.length + ' ready';
      if (items.length === 0) {
        wrap.innerHTML = '<p class="muted">No StatefulSets</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th><th>Ready</th><th>Desired</th></tr></thead><tbody>' +
        items.map(d => '<tr><td>' + escapeHtml(d.name) + '</td><td>' + escapeHtml(d.namespace) + '</td><td>' + d.ready + '</td><td>' + d.desired + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function renderDaemonSets(data) {
      const wrap = document.getElementById('daemonsets-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const items = data.daemonsets || [];
      document.getElementById('daemonsets-value').textContent = items.length;
      document.getElementById('daemonsets-value').className = 'value';
      const allReady = items.filter(d => d.ready === d.desired).length;
      const nsSel = document.getElementById('namespace-select').value;
      document.getElementById('daemonsets-meta').textContent = (nsSel ? 'Namespace: ' + nsSel + ' · ' : '') + allReady + '/' + items.length + ' ready';
      if (items.length === 0) {
        wrap.innerHTML = '<p class="muted">No DaemonSets</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th><th>Desired</th><th>Current</th><th>Ready</th></tr></thead><tbody>' +
        items.map(d => '<tr><td>' + escapeHtml(d.name) + '</td><td>' + escapeHtml(d.namespace) + '</td><td>' + d.desired + '</td><td>' + d.current + '</td><td>' + d.ready + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function renderConfigMaps(data) {
      const wrap = document.getElementById('configmaps-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const items = data.configmaps || [];
      document.getElementById('configmaps-value').textContent = items.length;
      document.getElementById('configmaps-value').className = 'value';
      const nsSel = document.getElementById('namespace-select').value;
      document.getElementById('configmaps-meta').textContent = nsSel ? 'Namespace: ' + nsSel : 'All namespaces';
      if (items.length === 0) {
        wrap.innerHTML = '<p class="muted">No ConfigMaps</p>';
        return;
      }
      const sample = items.slice(0, 100);
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th></tr></thead><tbody>' +
        sample.map(c => '<tr><td>' + escapeHtml(c.name) + '</td><td>' + escapeHtml(c.namespace) + '</td></tr>').join('') +
        '</tbody></table>' + (items.length > 100 ? '<p class="meta">Showing first 100 of ' + items.length + '</p>' : '');
    }

    function renderSecrets(data) {
      const wrap = document.getElementById('secrets-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const items = data.secrets || [];
      document.getElementById('secrets-value').textContent = items.length;
      document.getElementById('secrets-value').className = 'value';
      const nsSel = document.getElementById('namespace-select').value;
      document.getElementById('secrets-meta').textContent = nsSel ? 'Namespace: ' + nsSel : 'All namespaces';
      if (items.length === 0) {
        wrap.innerHTML = '<p class="muted">No Secrets</p>';
        return;
      }
      const sample = items.slice(0, 100);
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th><th>Type</th></tr></thead><tbody>' +
        sample.map(s => '<tr><td>' + escapeHtml(s.name) + '</td><td>' + escapeHtml(s.namespace) + '</td><td>' + escapeHtml(s.type || '—') + '</td></tr>').join('') +
        '</tbody></table>' + (items.length > 100 ? '<p class="meta">Showing first 100 of ' + items.length + '</p>' : '');
    }

    function renderJobs(data) {
      const wrap = document.getElementById('jobs-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const items = data.jobs || [];
      document.getElementById('jobs-value').textContent = items.length;
      document.getElementById('jobs-value').className = 'value';
      const complete = items.filter(j => j.complete).length;
      const nsSel = document.getElementById('namespace-select').value;
      document.getElementById('jobs-meta').textContent = (nsSel ? 'Namespace: ' + nsSel + ' · ' : '') + complete + ' complete';
      if (items.length === 0) {
        wrap.innerHTML = '<p class="muted">No Jobs</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th><th>Succeeded</th><th>Failed</th><th>Active</th><th>Complete</th></tr></thead><tbody>' +
        items.map(j => '<tr><td>' + escapeHtml(j.name) + '</td><td>' + escapeHtml(j.namespace) + '</td><td>' + j.succeeded + '</td><td>' + j.failed + '</td><td>' + j.active + '</td><td>' + (j.complete ? 'Yes' : '—') + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function renderCronJobs(data) {
      const wrap = document.getElementById('cronjobs-table-wrap');
      if (data.error) {
        wrap.innerHTML = '<p class="error-msg">' + escapeHtml(data.error) + '</p>';
        return;
      }
      const items = data.cronjobs || [];
      document.getElementById('cronjobs-value').textContent = items.length;
      document.getElementById('cronjobs-value').className = 'value';
      const suspended = items.filter(c => c.suspended).length;
      document.getElementById('cronjobs-meta').textContent = suspended ? suspended + ' suspended' : 'CronJobs';
      if (items.length === 0) {
        wrap.innerHTML = '<p class="muted">No CronJobs</p>';
        return;
      }
      wrap.innerHTML = '<table><thead><tr><th>Name</th><th>Namespace</th><th>Schedule</th><th>Last run</th><th>Suspended</th></tr></thead><tbody>' +
        items.map(c => '<tr><td>' + escapeHtml(c.name) + '</td><td>' + escapeHtml(c.namespace) + '</td><td>' + escapeHtml(c.schedule || '—') + '</td><td>' + (c.lastSchedule ? escapeHtml(c.lastSchedule.replace('T', ' ').slice(0, 19)) : '—') + '</td><td>' + (c.suspended ? 'Yes' : '—') + '</td></tr>').join('') +
        '</tbody></table>';
    }

    function relativeTime(isoStr) {
      if (!isoStr) return '';
      const d = new Date(isoStr);
      const now = new Date();
      const sec = Math.floor((now - d) / 1000);
      if (sec < 10) return 'just now';
      if (sec < 60) return sec + 's ago';
      const min = Math.floor(sec / 60);
      if (min < 60) return min + ' min ago';
      const hr = Math.floor(min / 60);
      if (hr < 24) return hr + ' hr ago';
      return Math.floor(hr / 24) + ' days ago';
    }

    function updateRelativeTime() {
      const el = document.getElementById('page-relative');
      if (lastUpdatedAt) el.textContent = 'Updated ' + relativeTime(lastUpdatedAt);
    }

    function applyInterval() {
      const sec = parseInt(document.getElementById('interval-select').value, 10);
      if (refreshIntervalId) clearInterval(refreshIntervalId);
      refreshIntervalId = null;
      if (sec > 0) refreshIntervalId = setInterval(loadAll, sec * 1000);
    }

    async function copySummary() {
      try {
        const data = await fetchApi('/workloads');
        const json = JSON.stringify(data, null, 2);
        await navigator.clipboard.writeText(json);
        const btn = document.querySelector('button[onclick="copySummary()"]');
        if (btn) {
          const orig = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(function() { btn.textContent = orig; }, 2000);
        }
      } catch (e) {
        alert('Failed to copy: ' + (e.message || e));
      }
    }

    function escapeHtml(s) {
      if (s == null) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    async function fetchApi(path, params) {
      const base = API || '';
      let url = (base.endsWith('/') ? base.slice(0, -1) : base) + '/api' + (path.startsWith('/') ? path : '/' + path);
      if (params && Object.keys(params).length) {
        const q = new URLSearchParams(params).toString();
        url += (url.includes('?') ? '&' : '?') + q;
      }
      const res = await fetch(url);
      if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
      return res.json();
    }

    async function loadAll() {
      setHealth(null);
      document.getElementById('page-timestamp').textContent = 'Loading…';
      document.getElementById('page-relative').textContent = '';
      var refreshEl = document.getElementById('refresh-status');
      if (refreshEl) { refreshEl.textContent = 'Refreshing…'; refreshEl.setAttribute('aria-busy', 'true'); }
      document.querySelector('.header-sticky').classList.add('refreshing');
      const ns = document.getElementById('namespace-select').value;

      try {
        const [health, nodes, namespaces, pods, services, ingresses, deployments, statefulsets, daemonsets, configmaps, secrets, jobs, cronjobs, pv, pvc, sc, fluxK, fluxHelm, fluxGit] = await Promise.all([
          fetchApi('/health'),
          fetchApi('/nodes'),
          fetchApi('/ns'),
          fetchApi('/pods', ns ? { namespace: ns } : {}),
          fetchApi('/svc', ns ? { namespace: ns } : {}),
          fetchApi('/ingresses', ns ? { namespace: ns } : {}),
          fetchApi('/deployments', ns ? { namespace: ns } : {}),
          fetchApi('/statefulsets', ns ? { namespace: ns } : {}),
          fetchApi('/daemonsets', ns ? { namespace: ns } : {}),
          fetchApi('/configmaps', ns ? { namespace: ns } : {}),
          fetchApi('/secrets', ns ? { namespace: ns } : {}),
          fetchApi('/jobs', ns ? { namespace: ns } : {}),
          fetchApi('/cronjobs', ns ? { namespace: ns } : {}),
          fetchApi('/pv'),
          fetchApi('/pvc', ns ? { namespace: ns } : {}),
          fetchApi('/sc'),
          fetchApi('/flux/kustomizations'),
          fetchApi('/flux/helmreleases'),
          fetchApi('/flux/gitrepositories'),
        ]);

        setHealth(health.status === 'healthy');
        lastUpdatedAt = health.timestamp || new Date().toISOString();
        document.getElementById('page-timestamp').textContent = 'Last updated: ' + lastUpdatedAt;
        if (refreshEl) { refreshEl.textContent = ''; refreshEl.removeAttribute('aria-busy'); }
        document.querySelector('.header-sticky').classList.remove('refreshing');
        updateRelativeTime();

        // Populate namespace dropdown (keep current selection if still present)
        const sel = document.getElementById('namespace-select');
        const current = sel.value;
        sel.innerHTML = '<option value="">All namespaces</option>';
        (namespaces.namespaces || []).forEach(function(n) {
          const opt = document.createElement('option');
          opt.value = n;
          opt.textContent = n;
          if (n === current) opt.selected = true;
          sel.appendChild(opt);
        });

        renderNodes(nodes);
        renderPods(pods);
        renderServices(services);
        renderIngresses(ingresses);
        renderDeployments(deployments);
        renderStatefulSets(statefulsets);
        renderDaemonSets(daemonsets);
        renderConfigMaps(configmaps);
        renderSecrets(secrets);
        renderJobs(jobs);
        renderCronJobs(cronjobs);
        renderPv(pv);
        renderPvc(pvc);
        renderStorageClasses(sc);
        renderFluxK(fluxK);
        renderFluxHelm(fluxHelm);
        renderFluxGit(fluxGit);
      } catch (err) {
        setHealth(false);
        document.getElementById('page-timestamp').textContent = 'Error: ' + err.message;
        if (refreshEl) { refreshEl.textContent = ''; refreshEl.removeAttribute('aria-busy'); }
        document.querySelector('.header-sticky').classList.remove('refreshing');
        document.getElementById('nodes-table-wrap').innerHTML = '<p class="error-msg">Failed to reach API. Is the backend running? Use Ingress so frontend and API are same-origin, or enable CORS.</p>';
        document.getElementById('pods-table-wrap').innerHTML = '';
        document.getElementById('deployments-table-wrap').innerHTML = '';
        document.getElementById('services-table-wrap').innerHTML = '';
        document.getElementById('ingresses-table-wrap').innerHTML = '';
        document.getElementById('pv-table-wrap').innerHTML = '';
        document.getElementById('pvc-table-wrap').innerHTML = '';
        document.getElementById('sc-table-wrap').innerHTML = '';
        document.getElementById('statefulsets-table-wrap').innerHTML = '';
        document.getElementById('daemonsets-table-wrap').innerHTML = '';
        document.getElementById('configmaps-table-wrap').innerHTML = '';
        document.getElementById('secrets-table-wrap').innerHTML = '';
        document.getElementById('jobs-table-wrap').innerHTML = '';
        document.getElementById('cronjobs-table-wrap').innerHTML = '';
        document.getElementById('flux-k-table-wrap').innerHTML = '';
        document.getElementById('flux-helm-table-wrap').innerHTML = '';
        document.getElementById('flux-git-table-wrap').innerHTML = '';
        document.getElementById('nodes-value').textContent = '—';
        document.getElementById('pods-value').textContent = '—';
        document.getElementById('deployments-value').textContent = '—';
        document.getElementById('services-value').textContent = '—';
        document.getElementById('ingresses-value').textContent = '—';
        document.getElementById('pv-value').textContent = '—';
        document.getElementById('pvc-value').textContent = '—';
        document.getElementById('sc-value').textContent = '—';
        document.getElementById('statefulsets-value').textContent = '—';
        document.getElementById('daemonsets-value').textContent = '—';
        document.getElementById('configmaps-value').textContent = '—';
        document.getElementById('secrets-value').textContent = '—';
        document.getElementById('jobs-value').textContent = '—';
        document.getElementById('cronjobs-value').textContent = '—';
        document.getElementById('flux-k-value').textContent = '—';
        document.getElementById('flux-helm-value').textContent = '—';
      }
    }

    loadAll();
    applyInterval();
    setInterval(updateRelativeTime, 10000);
  </script>
</body>
</html>

apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-website
spec:
  replicas: 2
  selector:
    matchLabels:
      app: test-website
  template:
    metadata:
      labels:
        app: test-website
    spec:
      containers:
      - name: dashboard
        image: nginx:alpine
        command: ["/bin/sh"]
        args:
        - -c
        - apk add --no-cache curl jq && while true; do FLUX=$(kubectl get kustomizations --no-headers -n flux-workloads 2>/dev/null||echo "flux"); GIT=$(kubectl get gitrepository kafka-infra -o jsonpath='{.status.artifact.revision}' -n flux-workloads 2>/dev/null||echo "git"); PODS=$(kubectl get pods --no-headers -n apps 2>/dev/null|wc -l||echo "0"); cat > /usr/share/nginx/html/index.html << EOF && echo "<h1>NKP-CICD Live \$(date)</h1><pre>Flux:\\n\$FLUX\\nGit: \$GIT\\nPods: \$PODS</pre>" > /usr/share/nginx/html/index.html && sleep 15; done & nginx -g 'daemon off;'
        ports:
        - containerPort: 80

